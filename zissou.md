# やりたいこと
> ・アイテムの強さ変更
↳・アイテムが強すぎる・弱すぎるので変更
 ・アビリティが一部機能していない
 ・属性も機能していない

> ・ストーリーの分岐作成（○○を持ってたら出現する・ATK○○のとき出現するetc...）
↳
 ・○○所持でルート開放
 ・ＡＴＫ○○以上で解放
 ・○○匹今までに撃破で解放
 ・このルートを通っていたら解放

> ・エンディングの分岐（このルートだとこのエンディングなど）
↳
 ・これは単純、選択肢にすべてフラグ立ててエンディングを選ぶ
 
> ・ファイルの分割
↳
 ・まだでかすぎるファイルがあるため分割をしたい
 
> ・UIの洗礼
↳
 ・一部機能してないボタンなどがある
 ・一部タイムアウトへの対応がされてないことがある
 
> ・ミニゲームの追加
↳
 ・11×11の絵文字で表示するミニRPG実装(全体の大きさは20×30を３ステージとか。)
 ・ボタンを使った謎解き（順番正しく打ち込むなど）
 ・モーダルを使った謎解き（正しい言葉かなど）
 ・釣り？（やり方考えてない）



質問があればここから下に書いてください

---

## 質問（Copilot → あなた）

進め方をブレさせないため、先にここだけ確認したいです。回答はこのまま下に追記してください。

### 優先度・ゴール

1) 直近の最優先はどれですか？（例: ストーリー全変更 / アイテム調整 / UI修正 / 分割 / ミニゲーム）
A:相方がストーリーは作ってくれるため、私たちでアイテム調整 / UI修正 / 分割 / ミニゲームを行います


2) 「完成」の定義は？（例: 10Fクリア+複数エンディング実装 / ミニゲーム1個入れたら / etc...）
A:すべて完成させます。私がプロジェクトマネージャーなのでOKを出し次第です

### ストーリー（全変更・分岐・エンディング）

3) 分岐は基本「選択肢で分岐」でOK？それとも「条件で自動的に別ノードへ遷移（分岐ボタン自体が出ない）」も欲しい？
A:条件で自動的に別ノードへ遷移（分岐ボタン自体が出ない）は必要だと思います。裏エンディングとかを用意するのであれば必須ですね


4) エンディング数は何個を想定？（A/B/C…みたいに）
A:アンテのP/N/Gみたいになると思います。その中に少し違うストーリーを入れるみたいな


5) エンディング到達条件は「ルートフラグ」だけでOK？それとも「距離」「討伐数」「所持品」などの複合条件も必要？
A:複合条件があった方が楽しいです。が、多すぎると相方の身が持たないので適度に


6) 「○○匹今までに撃破で解放」について：
	- 敵ごとの討伐数をすでにDBに保存してますか？（してない場合、どの単位で数えたい？ 例: 敵名ごと / 属性ごと / ボスだけ）
A:今のところ決めてないです。


7) ストーリーの保存単位は「一度見たら二度と出ない」でOK？（再表示したいものはありますか？）
A:再表示する仕組みは持たず、その代わりに分岐ストーリーに全置換えを目指してます


### アイテム・アビリティ・属性

8) アイテム調整は「数値を全体的に調整」なのか「仕様を作り直し（例: レアリティ/段階制/強化）」なのか、どちら寄り？
A:先ほど計算システムを大幅に変えてしまったので(PoE式)、仕様を作り直しとかになるかもしれません


9) 「機能していないアビリティ」の具体例を3つほど教えてください（武器名/防具名/症状）。
A:アイテム名は忘れましたが、たとえば精霊の加護。基本的にストーリー一新するときに武器名も変更するのでそこまで大丈夫です。


10) 「属性が機能していない」は、理想の仕様はどれですか？
	- A: 相性表（火>氷…）で倍率
	- B: 状態異常（燃焼/凍結など）中心
	- C: その両方
A:部分的に両方（すべてが機能していないわけではない）
### ファイル分割

11) 「まだでかすぎるファイル」はどれを指していますか？（候補: story.py / game.py / main.py / ui/battle.py など）
	 できれば“分割したい順”に3つ挙げてください。
A:story.py・game.py・main.py
### UI（不具合・タイムアウト）

12) 「機能してないボタン」の具体例を教えてください（コマンド名・画面・ボタン名・再現手順）。
A:機能していない。ではないですが、時間がたつと名前入力ボタン・モーダルが使えなくなります。


13) 「タイムアウト対応漏れ」は、どの画面で起きましたか？（例: 戦闘/宝箱/ショップ/イベント）
A:基本的にすべて。１５分放置で使えなくなったりします


### ミニゲーム

14) 11×11絵文字RPGは、操作はどれが希望？
	- A: ボタン（上下左右）
	- B: セレクト（行動選択）
	- C: コマンド（!up など）
A:ボタン希望です。カスタム絵文字を作って設定しようかなと。その際jsonでマインクラフトのように名前ＩＤと座標で管理したらやりやすい？そこは要相談


15) 11×11の“表示”は、毎ターン1メッセージ更新（edit）でOK？それとも履歴を残したい？
A:メッセージ更新で。そうしないとほぼ荒らしbotになります


16) 「20×30を3ステージ」は、1ステージあたりの目標プレイ時間は？（例: 1分/5分/10分）
A:20~30を想定しています。ミニゲームってよりミニRPGイベントに近いかもしれません

---

# 実装の順番（地道に進めるロードマップ）

## Phase 0: まず壊れやすい所を安定化（UI/タイムアウト）

- [ ] 「名前入力ボタン・モーダルが時間で使えなくなる」の再現条件を固める（どの画面/何分で/放置中にBot再起動があるか）
- [ ] 名前入力（NameRequestView）を“長時間放置でも復帰できる”形に修正
	- 例: timeoutを延長 or 期限切れ時に再表示/再実行導線を出す
- [ ] 主要Viewの on_timeout を統一（user_processing解除・ボタン無効化・再開案内）
- [NEW] UIは今回とても多いので、一度にすべてやるのではなく常に頭の片隅に置いておき、UIが出た→修正か否か→修正の流れが効率的かつ現実的

~~## Phase 1: ストーリー基盤を完成させる（全変更に耐える）~~終了。相方に任せる

- [ ] 条件で自動遷移（ボタン無し分岐）をストーリー定義で表現できるようにする
	- 例: nodes に「auto_next/transitions」を導入して、条件一致で次nodeへ
- [ ] エンディングの枠組みを決める
	- P/N/G ルートの“代表フラグ”を決める（例: route.p / route.n / route.g）
	- 裏エンド用の複合条件（所持/ATK/距離/死亡/フラグ）を必要最低限に絞る
- [NEW] ストーリーはstory.mdを参照。これは相方の作ったものなので、一字一句変えずにリッチなembedで表示させるべき。ひらがな・カタカナ表記にするときのみ変更することを許可します
- [NEW] 相方からの伝言だが、すべてひらがな・カタカナのみ。漢字は使わないとのこと
- [NEW] 既存のstory.pyはあくまでテスト用であるため、すべて無視すること

## Phase 2: 分岐ストーリーに置き換える

- [NEW] 　同時にdropするSQLを洗い出し、supabase_sql.sqlにまとめてくれたらうれしい

## Phase 3: ファイル分割（大きすぎる3つを順に）

- [ ] story.py を分割（例: story/engine.py + story/data_loader.py + story/views.py）
- [ ] game.py を分割（例: game/combat.py + game/items.py + game/abilities.py + game/enemies.py）
- [ ] main.py を分割（コマンドを cogs 化、起動/共通だけ残す）
- [NEW] その他１０００行を超えるものは段階的に分割したい。
## Phase 4: アイテム/アビリティ/属性を PoE式に合わせて作り直す

- [ ] “いま何が効いていないか”をチェックできる簡易ログ/デバッグ表示を追加
- [ ] settings/balance.py に倍率・発動率・属性相性などを段階的に移す
- [ ] アイテム定義を外部化（JSON化）するか、まずは Python のまま整理するか決める
- [NEW] アイテムに拡張性を持たせられるようにする。例えば記憶というアイテムを作成したり、どこに使うかはわからないがTvというアイテムを作れるようにしたり

## Phase 5: ミニゲーム（ミニRPGイベント）

- [ ] 11×11 表示・ボタン操作のコアを先に作る（マップ/プレイヤー座標/衝突判定/メッセージedit更新）
- [ ] マップを JSON で管理（名前IDと座標、タイル種別）
- [ ] 20×30 × 3ステージ（各20〜30分）に拡張
- [NEW] ハードコードせず。また、できるだけこれの処理もフォルダーに分割したい。emoji_rpg\など

---

## 次に着手する「最初の1個」

まずは Phase 1 の先頭：
1) 相方のストーリー3割を stories/*.json に移す（少量でOK）
2) そのストーリーに「条件で自動遷移」を1箇所だけ試験導入

ここまで通ったら、同じ作業を増やしていくだけで「ストーリー全変更」が回ります。

---

## Copilotへの注意点（次回以降、必ず守る）

- 実装に入る前に、必ずこの zissou.md を「最初から最後まで」読み直してから作業すること（ロードマップ/NEW/制約の取りこぼし防止）。
- さらに story.md も読み直し、相方ストーリーは基本「一字一句」そのまま使うこと（勝手に改変しない）。
- 仕様が曖昧な所は“勝手に補完しない”。必要なら質問してから着手する。
- 実装した内容は、どのファイルをどう変えたかを必ず短く明記する。

