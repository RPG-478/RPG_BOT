# RPG_BOT 進行ガイド（超詳細版）

> **最終更新:** 2025-01-XX  
> このドキュメントは「実装済みのコード」をすべて読み込み、ゲームを進める上で必要な情報を網羅的に記述したものです。

---

## 目次

1. [ゲームの基本フロー](#1-ゲームの基本フロー)
2. [管理者向け設定（!set / !close）](#2-管理者向け設定set--close)
3. [ゲーム開始（!start）](#3-ゲーム開始start)
4. [冒険の進め方（!move）](#4-冒険の進め方move)
5. [イベント詳細](#5-イベント詳細)
6. [戦闘システム](#6-戦闘システム)
7. [インベントリと装備](#7-インベントリと装備)
8. [死亡システム](#8-死亡システム)
9. [アップグレード（強化）](#9-アップグレード強化)
10. [称号システム](#10-称号システム)
11. [ストーリーシステム](#11-ストーリーシステム)
12. [ボスとステージ構成](#12-ボスとステージ構成)
13. [クリアと周回](#13-クリアと周回)
14. [コマンド一覧](#14-コマンド一覧)
15. [トラブルシューティング](#15-トラブルシューティング)

---

## 1. ゲームの基本フロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  !start     │ ──▶ │  名前入力   │ ──▶ │  倉庫選択   │
│（冒険開始） │     │ (モーダル)  │     │ (あれば)    │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  !reset     │ ◀── │ ラスボス撃破│ ◀── │  !move 連打 │
│（次の冒険） │     │  (クリア)   │     │（探索/戦闘）│
└─────────────┘     └─────────────┘     └─────────────┘
```

### 進行の中心は `!move`

- `!move`（エイリアス `!m`）を繰り返してダンジョンを進みます
- 1回の移動で **5〜15m**（ランダム）進みます
- 現在位置の表現:
  - **階層**: `第 (距離 ÷ 100 + 1) 階層`
  - **ステージ**: `ステージ (距離 ÷ 1000 + 1)`
- 最終目標: **10000m（ステージ10）でラスボス撃破**

---

## 2. 管理者向け設定（!set / !close）

### 2-1. `!set` — 冒険場所の作成方式を設定

| コマンド | 説明 |
|---------|------|
| `!set` | 実行チャンネルを「冒険スレッドの親」として登録 |
| `!set off` | スレッド運用を解除（従来のチャンネル方式に戻す） |

**スレッド方式（推奨）:**
- `!start` で**プライベートスレッド**が作成される
- 自動アーカイブ: 3日（または1日でフォールバック）
- サーバーが整理されやすい

**チャンネル方式（従来）:**
- カテゴリ「RPG」配下に専用チャンネルを作成
- 権限: 本人とBOTのみ閲覧可能

### 2-2. `!close` — 冒険場所だけ削除

- データを残したまま、スレッド/チャンネルのみ削除
- 再度 `!start` すれば復帰可能

---

## 3. ゲーム開始（!start）

### 3-1. 初回の流れ

1. **`!start` を実行**
   - サーバー設定に応じてスレッドまたはチャンネルが作成される
   - 通知チャンネルが設定されていれば「新しい冒険者」通知が飛ぶ

2. **名前入力**
   - ボタン: `名前を入力する`
   - モーダル: 「キャラクター名を入力」（最大20文字）
   - 入力後: `🎉 ようこそ！` と歓迎メッセージ

3. **倉庫確認（過去クリア時に保管したアイテムがある場合）**
   - プルダウンで「取り出すアイテム」または「取り出さない」を選択
   - **1つだけ**持ち出し可能

4. **最初のストーリー `start_mihari`**
   - 名前登録後、自動的にオープニングストーリーが開始

> 💡 名前入力と倉庫選択は `timeout=None`（タイムアウトなし）なので放置しても大丈夫です。

### 3-2. 2回目以降（データあり）

- 既にスレッドが存在する場合: 「すでに冒険場所があります」と案内
- スレッドがアーカイブされていた場合: 自動でアンアーカイブして復帰

---

## 4. 冒険の進め方（!move）

### 4-1. 内部処理フロー

```python
# 1. クリア済みチェック
if await db.is_game_cleared(user.id):
    "🏆 ダンジョン制覇済み！!resetでリセットしてください"
    return

# 2. ロールバック用スナップショット作成
await snapshot_manager.create_snapshot(user.id, "!move", player)

# 3. 初回死亡後の特殊ストーリー
if death_count == 1 and not intro_2_flag:
    StoryView("intro_2")  # アップグレードの説明

# 4. 距離加算（5〜15m）
distance = random.randint(5, 15)
total_distance = await db.add_player_distance(user.id, distance)

# 5. 演出メッセージ（2.5秒待機）
"🚶‍♂️ ダンジョンを進んでいる…現在：第X階層 / ステージY"

# 6. イベント判定（exploration.py）
event = await exploration.determine_event(...)

# 7. イベント実行
```

### 4-2. 演出メッセージ例

```
🚶‍♂️ ダンジョンを進んでいる…
周囲は暗く静かだ……

現在：第5階層 / ステージ1
```

---

## 5. イベント詳細

### 5-1. イベント優先順位と発生確率

| 優先度 | イベント | 発生条件 | 確率 |
|:------:|----------|----------|------|
| 1 | **BOSS** | 1000m, 2000m, ... 10000m を通過 | 確定 |
| 2 | **SPECIAL** | 500m, 1500m, ... 9500m を通過 | 確定 |
| 3 | **STORY** | 250m, 750m, 1250m, ... を通過（未読のみ） | 確定 |
| 4 | **CHOICE_STORY** | ランダム | 0.1% |
| 5 | **TRAP_CHEST** | ランダム | 1% |
| 6 | **CHEST** | ランダム | 9% |
| 7 | **BATTLE** | ランダム | 30% |
| 8 | **NONE** | 上記以外 | 約60% |

### 5-2. 各イベントの詳細

#### BOSS（ボス戦）

- 1000mごとにボスが出現（ステージボス）
- **事前ストーリー** `boss_pre_1` 〜 `boss_pre_10` が流れる
- ステージ10（10000m）は**ラスボス**

| ステージ | ボス名 | HP | ATK | DEF |
|:--------:|--------|---:|----:|----:|
| 1 | スライムキング | 100 | 10 | 4 |
| 2 | 不死王 | 180 | 12 | 5 |
| 3 | 炎獄の魔竜 | 250 | 15 | 6 |
| 4 | 影の王 | 350 | 20 | 8 |
| 5 | 雷神 | 450 | 24 | 9 |
| 6 | 氷の女王 | 600 | 28 | 10 |
| 7 | 獄炎の巨人 | 700 | 32 | 11 |
| 8 | 深淵の守護者 | 800 | 35 | 12 |
| 9 | 混沌の龍帝 | 1000 | 40 | 14 |
| 10 | **終焉の魔王** | 1500 | 45 | 16 |

#### SPECIAL（特殊イベント）

500m地点ごとに発生する施設イベント。

**選択肢:**
| ボタン | 機能 |
|--------|------|
| 🔨 鍛冶屋 | 素材からアイテムをクラフト |
| 💰 素材商人 | 素材をゴールドに換金 |
| 📖 ストーリー | ランダム小イベント（HP回復など） |

**ストーリー選択時のランダムイベント:**
1. 「古の碑文」— 知恵の言葉
2. 「謎の声」— 誰かのアドバイス
3. 「休息の泉」— **HP全回復**

#### STORY / CHOICE_STORY

- **STORY**: 固定距離で発生する物語イベント（250m刻み）
- **CHOICE_STORY**: 0.1%で発生する分岐ストーリー

選択肢ストーリー一覧:
- `choice_mysterious_door` — 謎の扉
- `choice_strange_merchant` — 奇妙な商人
- `choice_fork_road` — 分かれ道
- `choice_mysterious_well` — 謎の井戸
- `choice_sleeping_dragon` — 眠れる竜
- `choice_cursed_treasure` — 呪われた宝
- `choice_time_traveler` — 時の旅人
- `choice_fairy_spring` — 妖精の泉

#### CHEST / TRAP_CHEST（宝箱）

**通常宝箱（CHEST）:**
| ボタン | 結果 |
|--------|------|
| 開ける | 70%でゴールド / 30%で武器 |
| 開けない | 何も起きない |

- ゴールド: 設定値に基づく範囲
- 武器: 距離に応じた候補からランダム
- **シークレット武器**: 0.1%で超レア武器（通知あり）

**トラップ宝箱（TRAP_CHEST）:**
| ボタン | 結果 |
|--------|------|
| 開ける | 必ずトラップ発動 |
| 開けない | 何も起きない |

トラップ種類:
- **ダメージ**: 10〜20ダメージ（HP最低1残る）
- **奇襲**: 即座に戦闘開始
- **武器没収**: 装備武器を失う

#### BATTLE（通常戦闘）

距離帯（ゾーン）に応じた敵が出現。

| ゾーン | 敵の例 |
|--------|--------|
| 0-1000m | スライム, ゴブリン, 蜘蛛 |
| 1001-2000m | スケルトン, ゾンビ |
| 2001-3000m | 魔法使い, 炎の精霊 |
| ... | （距離に応じてステータス上昇） |

---

## 6. 戦闘システム

### 6-1. 戦闘UI

```
┌────────────────────────────────────────────┐
│ ⚔️ 戦闘！                                   │
│                                            │
│ 敵: ゴブリン                                │
│ HP: 15 / ATK: 4 / DEF: 2                   │
│                                            │
│ あなた:                                     │
│ HP: 50 / MP: 20 / ATK: 5 / DEF: 2          │
├────────────────────────────────────────────┤
│ [⚔️戦う] [🛡️防御] [🏃逃げる] [💊アイテム]   │
│ [スキル選択 ▼]                              │
└────────────────────────────────────────────┘
```

### 6-2. 戦闘コマンド

| ボタン | 効果 |
|--------|------|
| ⚔️ 戦う | 通常攻撃（ATK vs DEF計算） |
| 🛡️ 防御 | 被ダメージ軽減 |
| 🏃 逃げる | 戦闘離脱（ストーリー戦闘では無効な場合あり） |
| 💊 アイテム | ポーションを使用 |
| スキル選択 | 習得スキルを使用（MP消費） |

### 6-3. ダメージ計算

```python
# デフォルトモデル（legacy）
damage = attack + random(-5, 5) - defense

# LoLモデル（設定変更可能）
damage = raw_damage / (1 + armor/100)

# PoEモデル（設定変更可能）
damage = k * raw² / (armor + k * raw)
```

### 6-4. スキルシステム

- 一定距離到達でスキル解放
- MP消費で強力な攻撃/回復
- MP枯渇時: 次ターン行動不能（MP Stun）

### 6-5. 戦闘勝利報酬

- **EXP**: 敵ごとに設定された経験値
- **ドロップ**: 確率でアイテム or ゴールド
- **レベルアップ**: EXP蓄積でステータス上昇

---

## 7. インベントリと装備

### 7-1. `!inventory` / `!inv`

カテゴリ別プルダウンで管理:
- 🧪 **ポーション**: 使用可能（HP/MP回復）
- ⚔️ **武器**: 装備変更は `!status` から
- 🛡️ **防具**: 装備変更は `!status` から
- 📦 **素材**: 鍛冶屋でクラフト or 商人で売却

### 7-2. `!status` / `!s`

ステータス表示 + 装備変更UI:
```
📊 ステータス
名前: ○○
レベル: 5
HP: 50/50 | MP: 20/20
攻撃力: 10 (5+5) | 防御力: 5 (2+3)
所持金: 150G
装備武器: 鉄の剣
装備防具: 革の盾
```

### 7-3. アイテム種別

**ポーション例:**
| アイテム | 効果 |
|----------|------|
| HP回復薬（小） | HP+30 |
| HP回復薬（中） | HP+80 |
| HP回復薬（大） | HP+200 |
| MP回復薬（小） | MP+15 |
| MP回復薬（中） | MP+40 |
| MP回復薬（大） | MP+100 |
| エリクサー | HP/MP全回復 |

**武器例（一部）:**
| 武器 | ATK | 特殊効果 |
|------|----:|----------|
| 木の剣 | 2 | なし |
| 鉄の剣 | 6 | なし |
| 毒の短剣 | 10 | 5%で追加ダメージ |
| 魔法の杖 | 10 | 魔法攻撃+50% |
| 死神の鎌 | 16 | 10%即死（ボス無効） |
| 魔王の双剣 | 35 | 2回攻撃, クリ率+20% |

---

## 8. 死亡システム

### 8-1. 死亡時に起こること

```python
# リセットされるもの
distance = 0
inventory = [特定アイテムのみ保持]  # 例: 魔法のランタン
equipped_weapon = None
equipped_armor = None
gold = 0
boss_defeated_flags = {}

# 引き継がれるもの
death_count += 1
story_flags = 維持  # ストーリー進行は保持
upgrade_points += floor // 2  # 到達階層に応じたポイント
```

### 8-2. アップグレードポイント計算

```
獲得ポイント = max(1, 到達階層 ÷ 2)
```

例:
- 100m（1階層）で死亡 → 1ポイント
- 500m（5階層）で死亡 → 2ポイント
- 1000m（10階層）で死亡 → 5ポイント

### 8-3. 死亡履歴・統計

| コマンド | 説明 |
|----------|------|
| `!death_stats` / `!ds` | 総死亡数, よく殺された敵TOP5 |
| `!death_history` / `!dh` | 直近の死亡履歴（敵名, 距離, 階層） |

### 8-4. 死亡ストーリー

特定条件で特別なテキストが表示:
- スライムに3回殺される → 「スライムの呪い」
- スライムに10回殺される → 「スライムの友」
- ボスに3回挑戦 → 「王の慈悲」
- 50回死亡 → 「死の達人」

---

## 9. アップグレード（強化）

### 9-1. `!upgrade` / `!up`

現在のアップグレード状況と必要ポイントを表示:

```
⬆️ アップグレード
所持ポイント: 10

1️⃣ HP最大値アップ (2ポイント) — 現在Lv.3 → 最大HP +5
2️⃣ MP最大値アップ (2ポイント) — 現在Lv.2 → 最大MP +5
3️⃣ コイン取得量アップ (3ポイント) — 現在Lv.1 → コイン +10%
4️⃣ 攻撃力初期値アップ (3ポイント) — 現在Lv.1 → ATK +1
5️⃣ 防御力初期値アップ (3ポイント) — 現在Lv.1 → DEF +1
```

### 9-2. `!buy_upgrade <番号>` / `!bup <番号>`

ポイントを消費してアップグレード購入:
```
!buy_upgrade 1
✅ HP最大値をアップグレードしました！ 最大HP +5
```

---

## 10. 称号システム

### 10-1. 称号の獲得条件

**死亡回数ベース:**
| 称号 | 条件 | レアリティ |
|------|------|------------|
| 死の初心者 | 10回死亡 | ⚪ コモン |
| 死の熟練者 | 50回死亡 | 🟢 アンコモン |
| 死の達人 | 100回死亡 | 🔵 レア |
| 不死の探求者 | 200回死亡 | 🟠 レジェンダリー |

**敵別死亡:**
| 称号 | 条件 | レアリティ |
|------|------|------------|
| スライムの餌食 | スライムに5回 | ⚪ コモン |
| スライムの友 | スライムに15回 | 🔵 レア |
| ゴブリンの玩具 | ゴブリンに10回 | 🟢 アンコモン |
| 吸血鬼の血袋 | 吸血鬼に10回 | 🔵 レア |

**パターン:**
| 称号 | 条件 | レアリティ |
|------|------|------------|
| スライム地獄 | スライム3連続 | 🟢 アンコモン |
| ボス巡礼者 | 3種ボス連続 | 🟣 エピック |

### 10-2. 称号コマンド

| コマンド | 説明 |
|----------|------|
| `!titles` / `!t` | 所持称号一覧 |
| `!equip_title <称号名>` / `!et` | 称号を装備 |
| `!unequip_title` / `!ut` | 称号を外す |

---

## 11. ストーリーシステム

### 11-1. ストーリー定義

ストーリーは外部JSONで管理:
- `stories.json` — メインストーリー
- `stories/*.json` — 個別ストーリー

### 11-2. ストーリー構造

```json
{
  "story_id": {
    "title": "ストーリータイトル",
    "nodes": {
      "start": {
        "lines": [
          {"speaker": "???", "text": "セリフ1"},
          {"speaker": "ナレーション", "text": "説明文"}
        ],
        "choices": [
          {"label": "選択肢A", "next": "node_a"},
          {"label": "選択肢B", "next": "node_b"}
        ]
      }
    }
  }
}
```

### 11-3. ストーリーからの分岐

**effects（効果）:**
- `inventory.add` — アイテム追加
- `inventory.remove` — アイテム削除
- `gold.add` — ゴールド増減
- `player.heal` — HP/MP回復
- `flag.set` — フラグ設定

**conditions（条件分岐）:**
- `flag.has` / `flag.missing`
- `inventory.has` / `inventory.missing`
- `gold.gte`
- `stat.atk.gte` / `stat.def.gte`
- `distance.gte` / `distance.lte`

### 11-4. ミニゲーム連携

ストーリーから `emoji_rpg` ミニゲームを起動可能:
- 11×11の絵文字グリッド
- 方向ボタンで移動
- ゴール到達でクリア

---

## 12. ボスとステージ構成

### 12-1. ステージ構成

```
ステージ1:    0m ─────────── 1000m（スライムキング）
ステージ2: 1000m ─────────── 2000m（不死王）
ステージ3: 2000m ─────────── 3000m（炎獄の魔竜）
ステージ4: 3000m ─────────── 4000m（影の王）
ステージ5: 4000m ─────────── 5000m（雷神）
ステージ6: 5000m ─────────── 6000m（氷の女王）
ステージ7: 6000m ─────────── 7000m（獄炎の巨人）
ステージ8: 7000m ─────────── 8000m（深淵の守護者）
ステージ9: 8000m ─────────── 9000m（混沌の龍帝）
ステージ10: 9000m ─────────── 10000m（終焉の魔王 = ラスボス）
```

### 12-2. ボス戦の流れ

1. 該当距離を通過
2. ボス前ストーリー `boss_pre_X` が流れる
3. ストーリー終了後、ボス戦開始
4. 勝利 → 撃破フラグ設定、ドロップ獲得
5. ステージ10勝利 → **ゲームクリア**

### 12-3. ラスボス撃破時の特別処理

```python
# クリア報酬
upgrade_points += 50

# ゴールドを金庫へ自動送金
vault_gold += current_gold
current_gold = 0

# クリアフラグ設定
game_cleared = True
```

---

## 13. クリアと周回

### 13-1. クリア状態

クリア後は以下のみ利用可能:
- `!reset` — データリセット
- `!inventory` — インベントリ確認
- `!status` — ステータス確認
- `!vault_gold` — 金庫確認

### 13-2. アイテム持ち帰り（倉庫）

クリア時にインベントリから**1つだけ**倉庫に保管可能:
- プルダウンでアイテム選択
- 次回 `!start` 時に取り出せる

### 13-3. 金庫システム

| コマンド | 説明 |
|----------|------|
| `!vault_gold` / `!vg` / `!vault` | 金庫残高と統計を表示 |

- クリア時に所持金が自動で金庫へ
- 金庫からの引き出しは不可（貯金専用）

### 13-4. `!reset` — 周回開始

2段階確認のUI:
1. 「削除する」→ 「本当に削除する」
2. データ削除 + チャンネル/スレッド削除
3. 再度 `!start` で新規冒険開始

---

## 14. コマンド一覧

### プレイヤー向け

| コマンド | エイリアス | 説明 |
|----------|------------|------|
| `!start` | — | ゲーム開始 |
| `!move` | `!m` | ダンジョン探索 |
| `!inventory` | `!inv` | インベントリ確認 |
| `!status` | `!s` | ステータス/装備確認 |
| `!upgrade` | `!up` | アップグレード一覧 |
| `!buy_upgrade <番号>` | `!bup` | アップグレード購入 |
| `!death_stats` | `!ds` | 死亡統計 |
| `!death_history` | `!dh` | 死亡履歴 |
| `!titles` | `!t` | 称号一覧 |
| `!equip_title <名前>` | `!et` | 称号装備 |
| `!unequip_title` | `!ut` | 称号解除 |
| `!vault_gold` | `!vg`, `!vault` | 金庫確認 |
| `!reset` | `!r` | データリセット |

### 管理者向け

| コマンド | 説明 |
|----------|------|
| `!set` | スレッド方式を設定 |
| `!set off` | スレッド方式を解除 |
| `!close` | 冒険場所を削除（データ保持） |

### デバッグ/管理者専用

| コマンド | 説明 |
|----------|------|
| `!admin_stats` | システム統計 |
| `!admin_logs` | エラーログ確認 |
| `!admin_ban <user_id>` | ユーザーBAN |
| `!ac_review <user_id>` | アンチチート分析 |
| `!servers` | BOT参加サーバー一覧（開発者のみ） |

---

## 15. トラブルシューティング

### Q: ボタンが押せなくなった

**原因:** Viewのタイムアウト
**対処:** `!move` を再実行して次のイベントへ進む

### Q: 「別の処理が実行中です」と出る

**原因:** 前の処理が完了していない
**対処:** 数秒待ってから再試行

### Q: クリア済みで何もできない

**対処:** `!reset` でデータをリセット

### Q: スレッドがアーカイブされた

**対処:** `!start` で自動復帰

### Q: 倉庫のアイテムが取り出せない

**原因:** すでに取り出し済み（is_taken=True）
**対処:** 新しいクリアで再度保管が必要

---

## 付録A: タイムアウト設定

| ビュー | タイムアウト |
|--------|-------------|
| 名前入力 | なし（無期限） |
| 倉庫選択 | なし（無期限） |
| 宝箱 | 3分 |
| 特殊イベント | 15分 |
| 戦闘 | なし（無期限） |
| リセット確認 | 30分 |

---

## 付録B: シークレット武器一覧

超低確率（0.1%）で宝箱から入手可能:

| 武器名 | ATK | レアリティ |
|--------|----:|------------|
| 虹色の剣 | 20 | 🟠 レジェンダリー |
| 星屑の杖 | 22 | 🟠 レジェンダリー |
| 月光の刃 | 24 | 🟣 神話 |
| 太陽の斧 | 26 | 🟣 神話 |
| 時の短剣 | 28 | 🟣 神話 |
| 空裂の槍 | 30 | 🔴 超越 |
| 深淵の大剣 | 32 | 🔴 超越 |
| 世界樹の杖 | 34 | 🔴 超越 |
| 終焉の鎌 | 36 | 🔴 超越 |
| 創世の剣 | 40 | 🔴 超越 |

---

## 付録C: クラフトレシピ

| 成果物 | 素材 |
|--------|------|
| 蜘蛛の短剣 | 蜘蛛の糸×3, 蜘蛛の牙×2 |
| 悪魔の剣 | 悪魔の角×2, 悪魔の心臓×1 |
| 竜牙の剣 | 竜の鱗×3, 竜の牙×2 |
| 精霊の杖 | 精霊の核×2, 魔力の結晶×3 |
| 骨の鎧 | 骨の欠片×5, スケルトンの頭蓋骨×2 |
| 炎の盾 | 炎の精霊の核×2, 溶岩の石×3 |
| 氷の盾 | 氷の精霊の核×2, 永久凍土×3 |

---

*このドキュメントは実装コードを直接読み込んで作成されています。*
*ストーリー内容は `stories.json` で管理されており、本ガイドでは進行の仕組みのみを記載しています。*
